---
title: Java多线程
date: 2020-04-27 12:44:45
tags: 并发编程
categories: Java
cover: /img/myphotos/thread.jpg
---
## 前言

随着微处理器技术的飞速发展，个人计算机上的操作系统纷纷改用多任务和分时的设计。多任务就是指操作系统可以同时运行多个应用程序，为此操作系统引入了`进程`的概念。

## 概述

### 程序

程序就是指我们写的代码，在计算机世界内部其实也就是一条条指令，加上程序里要用到的数据，统统被保存在硬盘或者其它外部存储设备里。也就是说程序是静态的代码。

### 进程

硬盘里的程序经过一系列复杂的步骤后，被操作系统从硬盘调到主存中，然后CPU去访问主存把指令一个个取出来执行，这就是计算机的工作原理。在这里，这个程序的一次执行过程就叫做一个进程，换句话说，一个进程就是一个正在执行的程序，即代码是动态的。进程是操作系统资源分配和处理器调度的基本单位，各自拥有独立的代码、内部数据和运行状态。

多任务就是指在一个系统中可以同时运行多个进程，即有多个独立运行的任务，每个任务对应一个进程，每个进程都有自己专用的内存区域，即使是多次启动同一个程序，产生的多个进程也是如此。所谓的同时运行的进程，其实是由操作系统将系统资源分配给各个进程，每个进程在CPU上交替运行，也就是下面要说的并发执行。每个进程占有不同的内存区域，内存消耗很大，这使得系统在不同的应用进程之间切换时开销很大，进程之间的通信速度也很慢。

### 并行和并发

并发执行和并行执行并不相同。

在计算机中，一条指令是有它的指令周期（取址，间址，执行，中断）的，同一时刻，CPU上只能处理一条指令，这样一条条指令依次执行下去，我们叫做串行执行。

那如何同一时刻执行多条指令呢？这往往需要多个处理器的硬件支持，多条指令在多个CPU上同时执行，这就叫做并行执行。

在一个CPU上其实我们也可以做到伪”并行“的效果。这是因为计算机的运行速度非常快，一个指令周期人是根本感受不到的，那么在一个极短的时间段内，这个极短时间段也是人根本感受不到的，多条指令交替执行，这样给人的感觉就是这些指令是”同时“执行的，即所谓的”微观串行，宏观并行“，并发执行就是这样实现的。

+ 并发执行体现在程序上，就是将本来要顺序执行的程序代码，分成一个个相对独立的代码段，每一个代码段都是一个逻辑上相对完整的程序，那一会去执行一下这个代码段里的代码，一会又去执行一下那个代码段里的代码，这样快速交替执行这些代码段，看上去这些代码段就是“同时”执行的，这就实现了并发执行。

+ 在单处理器上，同一时刻始终还是只能执行一条代码，并发执行实质上还是串行执行。

### 线程

**为了减轻系统的负担，引入了线程的概念，将系统资源分配和处理器调度的基本单位分离。进程现在只是资源分配的基本单位，线程是处理器调度的基本单位。一个进程包含一个以上的线程，进程中的所有线程共享该进程的内存区域和数据。**

所谓的线程，其实与进程相似，也是一个执行中的程序，但线程是一个比进程更小的执行单位，有自身的产生、运行、消亡的过程：

![线程的生命周期](/img/myphotos/thread.png)

以往开发的程序，大多是单线程的，即一个程序只有从头到尾顺序执行这一条路径。然而现实世界中很多的过程都具有多条途径同时运作的特征。比如，我们可以一边喝咖啡，一边听音乐。再比如，一个Web服务器需要同时处理多个客户端的请求。

多线程就是指在同一个进程中同时存在多个执行体，将程序执行过程并发化。一个进程在执行过程中可以产生多个线程，形成多条执行路径。线程不能单独存在，必须存在于进程中，由于同一个进程中的线程是共享同一块内存区域的，所以系统在产生一个线程，或是在各个线程之间切换时，负担要比进程小很多，线程间的通信也快得多。让CPU在同一时间段内执行一个程序中的多个代码段，使工作完成得更有效率，这就是多线程的概念。

+ 要注意并发、多线程、多任务这些概念的区别。多线程是通过并发实现的，并发可以实现多个代码段的同时执行，那多线程就通过并发实现程序的多条执行路径同时执行。多线程和多任务是两个不同的概念。多任务是针对操作系统而言的，表示操作系统可以运行多个应用程序。而多线程是针对一个进程而言的，表示在一个进程内部同时执行多个线程。

### 线程的优先级和调度

在多线程的程序中，每个线程都被赋予了一个执行优先级。优先级决定了线程被CPU执行的优先顺序。优先级高的线程可以在一段时间内获得比优先级低的线程更多的执行时间。

线程的调度就是指在各个线程之间分配CPU资源，多个线程的并发执行实际上是通过一个调度模型来进行的。线程调度的模型有两种：分时模型和抢占模型。

在分时模型中，CPU资源是按时间片分配的，即把CPU的使用时间分成一片一片的。获得CPU使用权的线程，只能在指定的一个时间片内执行程序，一旦这个时间片使用完毕，就必须把CPU使用权让给另一个处于就绪状态的线程。分时模型的调度是没有优先级一说的，所有线程轮流获得CPU的使用权，并且平均分配时间片，每个线程获得相同数量的时间片。

在抢占模型中，优先让优先级高的线程使用CPU，如果优先级相同，则随机选择一个线程执行。一旦一个线程获得了CPU的使用权，这个线程将一直执行下去，直到该线程因为某种原因而不得不让出CPU的使用权。比如，一个正在执行的低优先级线程，碰到一个准备就绪的高优先级线程，就会把CPU使用权让出来，或者线程由于某种原因进入阻塞状态，又或者线程执行完毕。那么，为了让低优先级的线程有机会执行，应该让高优先级的线程时不时地进入“休眠”状态。

## 未完待续